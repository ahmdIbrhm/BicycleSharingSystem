<!DOCTYPE html>
<!-- Website template by freewebsitetemplates.com -->
<html>
<head>
	<meta charset="UTF-8">
	<title>Stats - Bicycle Sharing System</title>
	<link rel="stylesheet" href="css/style.css" type="text/css">
	<style type="text/css">
		hr { 
  display: block;
  margin-top: 0.5em;
  margin-bottom: 0.5em;
  margin-left: auto;
  margin-right: auto;
  border-style: inset;
  border-width: 1px;
} 
	</style>
</head>
<body onload="init()">
	<div id="header">
		<div class="wrapper clearfix">
			<div id="logo">
				<a href="index.html"><img src="" alt="LOGO"></a>
			</div>
			<ul id="navigation">
				<li>
					<a href="index.html">Map</a>
				</li>
				<li class="selected">
					<a href="about.html">Statistics</a>
				</li>
				<li >
					<a href="blog.html">Add Cities</a>
				</li>
				<li>
					<a href="contact.html">Contact Us</a>
				</li>
			</ul>
		</div>
	</div>
	<div id="contents">
		
	</div>
	<div id="footer">
		<div class="wrapper clearfix">
			<h1>Statistics</h1>

			<p style="font-size:120%;">Choose a city:
				<select id="select_city" onchange="selectCityListener()">
				</select>
			</p>

			<p style="font-size:120%;">Choose a station:
				<select id="select_station">
				</select>
			</p>
			<div>
				<p style="font-size:120%;">
					Start Date: <input type="date" id="start_date" />
				</p>
				<p style="font-size:120%;">
					End Date: <input type="date" id="end_date" />
				</p>
				
			</div>
			<input type="button" id="btn_render" onclick="renderResults()" value="Render results">
			
			<canvas id="myChart"></canvas>
			<hr>

		</div>
	</div>
	
</body>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.2/Chart.js"></script>
<script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
  <script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
<script type="text/javascript">
	function load(avBikesData,avDocksData,labels){

	var ctx = document.getElementById("myChart").getContext('2d');
	
	console.log(avBikesData)
	console.log(avDocksData)
	var mychart = new Chart(ctx,{
		"type":"line",
		"data":{
		"labels":labels,
		"datasets":[{
		"label":"Available bikes",
		"data":avBikesData,
		"fill":false,
		"borderColor":"rgb(75, 192, 192)",
		"lineTension":0.1},
		{
		"label":"Available docks",
		"data":avDocksData,
		"fill":false,
		"borderColor":"rgb(75, 100, 192)",
		"lineTension":0.1}
		]},
		"options":{}
	}); 
}

function init(){
    
    var dynamicSelect = document.getElementById("select_city");
   	var xhttp = new XMLHttpRequest();

    	xhttp.onreadystatechange = function() {
    		if (this.readyState == 4 && this.status == 200) {

    			var obj = JSON.parse(this.responseText);
    			var results = obj.results;
    			var bindings = results.bindings;
    			var str = '';
    			for (var i = 0; i < bindings.length; i++) {

    				var obj = bindings[i];
    				var name = obj['name'].value;
    				var uri = obj['city'].value;

    				dynamicSelect.innerHTML += "<option value=\""+uri+"\" >"+name+"</option>";

    			}
    			load([],[],[]);
    			selectCityListener();

    		}
    	};
    	xhttp.open("POST", "http://localhost:3030/test/query", true);
    	xhttp.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
    	xhttp.send("query=select ?city ?name where {?city <http://www.w3.org/1999/02/22-rdf-syntax-ns#type> <http://www.wikidata.org/entity/Q515> . ?city <http://www.w3.org/2000/01/rdf-schema#label> ?name }");

    }
    function selectCityListener() {
 		var selectedCity = document.getElementById("select_city").value;
  		 
    	var dynamicSelect = document.getElementById("select_station");
  		var xhttp = new XMLHttpRequest();
    	xhttp.onreadystatechange = function() {
    		if (this.readyState == 4 && this.status == 200) {

    			var obj = JSON.parse(this.responseText);
    			var results = obj.results;
    			var bindings = results.bindings;
    			var str = '';
    			dynamicSelect.innerHTML = "";
    			for (var i = 0; i < bindings.length; i++) {
    				var obj = bindings[i];
    				
    				var name = obj['name'].value;
    				var station = obj['station'].value;
    				
    				dynamicSelect.innerHTML += "<option value=\""+station+"\" >"+name+"</option>";
    			}
    		}
    	};

    	xhttp.open("POST", "http://localhost:3030/test/query", true);
    	xhttp.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
    	// must add station rdf:type Station ... in the model ...

    	var query = "query=PREFIX wdt: <http://www.wikidata.org/prop/direct/> select ?station ?name where {\
    					?station <http://www.w3.org/2003/01/geo/wgs84_pos#long> ?lon ; <http://www.w3.org/2003/01/geo/wgs84_pos#lat> ?lat ; <http://www.w3.org/2000/01/rdf-schema#label> ?name ; wdt:P276 <"+selectedCity+">\
    					} ";
		xhttp.send(query);

	}
	function renderResults(){
		
		if(document.getElementById("start_date").value == "" || document.getElementById("end_date").value == ""){
			swal("Error!", "Choose start and end date!", "error");
		}else{
			var start_date = new Date(document.getElementById("start_date").value);
			var end_date = new Date(document.getElementById("end_date").value);

			start_date = parseInt(start_date.getTime()/1000);
			end_date = parseInt(end_date.getTime()/1000);

			var xhttp = new XMLHttpRequest();
	    	xhttp.onreadystatechange = function() {
	    		if (this.readyState == 4 && this.status == 200) {

	    			var obj = JSON.parse(this.responseText);
	    			var results = obj.results;
	    			var bindings = results.bindings;
	    			var str = '';
	    			var avBikesData = []
	    			var avDocksData = []
	    			var labels = []
	    			for (var i = 0; i < bindings.length; i++) {
	    				var obj = bindings[i];
	    				
	    				var av_bikes = obj['av_bikes'].value;
	    				var av_docks = obj['av_docks'].value;
	    				var time = obj['time'].value;
	    				avBikesData.push(av_bikes)
	    				avDocksData.push(av_docks)
	    				labels.push(time)
	    			}
	    			load(avBikesData,avDocksData,labels)
	    		}
	    	};

	    	xhttp.open("POST", "http://localhost:3030/test/query", true);
	    	xhttp.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
	    	// must add station rdf:type Station ... in the model ...

	    	var selectedCity = document.getElementById("select_city").value;
	    	var selectedStation = document.getElementById("select_station").value;
	    

	    	var query = "query=PREFIX wdt: <http://www.wikidata.org/prop/direct/> select ?av_bikes ?av_docks ?time where {<"+selectedStation+"> <http://www.schema.org/State> ?state; wdt:P276 <"+selectedCity+"> . ?state <http://www.example.org/time> ?time; <http://www.example.org/availableBicycles>  ?av_bikes ; <http://www.example.org/availableDocks>  ?av_docks. FILTER (?time >= \""+start_date+"\")FILTER (?time <= \""+end_date+"\") }";

			xhttp.send(query);
		}	
	}

</script>
</html>
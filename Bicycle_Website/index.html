<!DOCTYPE html>
<!-- Website template by freewebsitetemplates.com -->
<html>
<head>
	<style type="text/css">
      html, body, #basicMap {
          height: 600px;  /* The height is 400 pixels */
        width: 100%;
      }
    </style>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css"
   integrity="sha512-xwE/Az9zrjBIphAcBb3F6JVqxf46+CDLwfLMHloNu6KEQCAWi6HcDUbeOfBIptF7tcCzusKFjFw2yuvEpDL9wQ=="
   crossorigin=""/>
   <script src="https://unpkg.com/leaflet@1.6.0/dist/leaflet.js"
   integrity="sha512-gZwIG9x3wUXg2hdXF6+rVkLF/0Vi9U8D2Ntg4Ga5I5BZpVkVxlJWbSQtXPSiUTtC0TjtGOmxa1AJPuV0CPthew=="
   crossorigin=""></script>
    <script >
    	var mymap;

    	function init() {
    	
    	mymap = L.map('basicMap');
 	 	L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw', {
		maxZoom: 18,
		attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, ' +
			'<a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ' +
			'Imagery Â© <a href="https://www.mapbox.com/">Mapbox</a>',
		id: 'mapbox.streets'
		}).addTo(mymap);
		loadMarkers();
    }
    function loadMarkers() {

    	var xhttp = new XMLHttpRequest();
    	xhttp.onreadystatechange = function() {
    		if (this.readyState == 4 && this.status == 200) {
    			var obj = JSON.parse(this.responseText);
    			var results = obj.results;
    			var bindings = results.bindings;
    			var str = '';
    			var center_lat = 0;
    			var center_lon = 0;
    			var counter = 0;
    			for (var i = 0; i < bindings.length; i++) {
    				var obj = bindings[i];
    				var lat_obj = obj['lat'];
    				var lon_obj = obj['lon'];

    				var lat_value = lat_obj.value;
    				var lon_value = lon_obj.value;
    				var capacity = obj['capacity'].value;
    				var name = obj['name'].value;
    				
    				var av_bikes = obj['av_bikes'].value;
    				var av_docks = obj['av_docks'].value;
    				var unix_timestamp = obj['max_date'].value;

    				var seconds = parseInt(new Date().getTime() / 1000);
    				var update_time = seconds - unix_timestamp;

 	 				L.marker([lat_value, lon_value ]).addTo(mymap).bindPopup('<b>Bicycle station</b> <br/> name: '+name+'<br/><h3>capacity:'+capacity+'</h3><h3>av_bikes: '+av_bikes+'<image src="images/dock.png" width="60" height="30"></h3>'+'<br/>av_docks: '+av_docks+'<image src="images/dock.png" width="60" height="30">'+'<br/>last updated: '+update_time+'s ago');
 	 				center_lat += parseFloat(lat_value);
 	 				center_lon += parseFloat(lon_value);
 	 				counter++;
    			}

    			center_lat = center_lat /counter;
    			center_lon = center_lon / counter;

    			mymap.setView([center_lat, center_lon], 13);
    		}
    	};
    	var dynamicSelect = document.getElementById("dynamic_select");

    	var selected_city = dynamicSelect[dynamicSelect.selectedIndex].value;

    	xhttp.open("POST", "http://localhost:3030/test/query", true);
    	xhttp.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
    	var query = "query=PREFIX wdt: <http://www.wikidata.org/prop/direct/> SELECT ?lat ?lon ?capacity ?name ?max_date ?av_bikes ?av_docks WHERE { ?station <http://www.w3.org/2003/01/geo/wgs84_pos#long> ?lon ; <http://www.w3.org/2003/01/geo/wgs84_pos#lat> ?lat ; <http://www.w3.org/2000/01/rdf-schema#label> ?name ; wdt:P1083 ?capacity ; wdt:P276 <"+selected_city+">{ SELECT ?station (MAX(?date) AS ?max_date) (MAX(?availableBicycles) as ?av_bikes) (MAX(?availableDocks) as ?av_docks) WHERE { ?station <http://www.schema.org/State> ?state . ?state <http://www.example.org/time> ?date ; <http://www.example.org/availableBicycles> ?availableBicycles ; <http://www.example.org/availableDocks> ?availableDocks; } group by ?station } }";

    	xhttp.send(query);

    }
    function createPopup(feature) {
      feature.popup = new OpenLayers.Popup.FramedCloud("pop",
          feature.geometry.getBounds().getCenterLonLat(),
          null,
          '<div class="markerContent">'+feature.attributes.description+'</div>',
          null,
          true,
          function() { controls['selector'].unselectAll(); }
      );
      //feature.popup.closeOnMove = true;
      map.addPopup(feature.popup);
    }

    function destroyPopup(feature) {
      feature.popup.destroy();
      feature.popup = null;
    }
    function loadCities(){
    
    var dynamicSelect = document.getElementById("dynamic_select");
   	var xhttp = new XMLHttpRequest();

    	xhttp.onreadystatechange = function() {
    		if (this.readyState == 4 && this.status == 200) {

    			var obj = JSON.parse(this.responseText);
    			var results = obj.results;
    			var bindings = results.bindings;
    			var str = '';
    			for (var i = 0; i < bindings.length; i++) {

    				var obj = bindings[i];
    				var name = obj['name'].value;
    				var uri = obj['city'].value;

    				dynamicSelect.innerHTML += "<option value=\""+uri+"\" >"+name+"</option>";

    			}
    			init();

    		}
    	};
    	xhttp.open("POST", "http://localhost:3030/test/query", true);
    	xhttp.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
    	xhttp.send("query=select ?city ?name where {?city <http://www.w3.org/1999/02/22-rdf-syntax-ns#type> <http://www.wikidata.org/entity/Q515> . ?city <http://www.w3.org/2000/01/rdf-schema#label> ?name }");

    }
    </script>
    <script type="application/ld+json">
    	{
    		"@context": "https://schema.org",
    		"@type": "Organization",
    		"url": "http://www.example.com",
    		"name": "Unlimited Ball Bearings Corp.",
    		"contactPoint": {
    		"@type": "ContactPoint",
    		"telephone": "+1-401-555-1212",
    		"contactType": "Customer service"
    	}
    }
</script>
	<meta charset="UTF-8">
	<title>Astronomy Website Template</title>
	<link rel="stylesheet" href="css/style.css" type="text/css">
	<link rel="stylesheet" href="css/combo.css" type="text/css">
	
</head>
<body onload="loadCities()">
	<div id="header">
		<div class="wrapper clearfix">
			<div id="logo">
				<a href="index.html"><img src="images/logo.png" width="60" height="50"></a>
			</div>
			<ul id="navigation">
				<li class="selected">
					<a href="index.html">Map</a>
				</li>
				<li>
					<a href="about.html">Stastics</a>
				</li>
				<li>
					<a href="blog.html">Add Cities</a>
				</li>
				<li>
					<a href="contact.html">Contact Us</a>
				</li>
			</ul>
		</div>
	</div>

	<div id="footer">
		<div class="wrapper clearfix">		
			<h3>Choose city:</h3>
			<select id="dynamic_select" onchange="loadMarkers()">

			</select>
			</br>
			<p style="font-size:160%;">Click on the markers viewed on the map to check bicycle stations information</p>
			</br>
			</br>
			</br>
			</br>
			
		</div>
		
	</div>
	<div id="contents">
		<div id="basicMap">
			
		</div>

	</div>

</body>
</html>